import{Z as b,u as E}from"./CTpYCmOx.js";import{h as T,w as k,x as S,R as L,a9 as P,a6 as O}from"./CoKilWGJ.js";const A={style:{display:"none"}},x=T({__name:"analytics-collector",setup(C){const u=b(),p=E();let o,a,c,s=null,i=null;const y=()=>{const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"},m=async()=>{try{const e=await fetch("/api/proxy/ipapi",{method:"GET",signal:AbortSignal.timeout(3e3)});if(!e.ok)throw new Error(`Erreur HTTP: ${e.status}`);const t=await e.json();return{country:t.country_name,city:t.city}}catch(e){return console.warn("Impossible de récupérer la localisation:",e),{country:"Unknown",city:"Unknown"}}},l=()=>u.hasGivenConsent&&u.preferences.analytics,_=()=>{s&&(document.removeEventListener("visibilitychange",s),s=null),i&&(window.removeEventListener("popstate",i),i=null)},w=()=>{l()&&(console.log("Démarrage du suivi analytique"),o=Date.now(),a=o,c=crypto.randomUUID(),f(),s=h,document.addEventListener("visibilitychange",s),i=f,window.addEventListener("popstate",i))},r=async()=>{console.log("Arrêt du suivi analytique"),_(),o&&await v()},f=async()=>{if(!l()){r();return}const e=Date.now(),t=a?e-a:0;a=e;const n=await m();try{const d=await fetch("/api/analytics/collect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"pageview",page_url:window.location.pathname,page_title:document.title,user_id:p.user?.id||"anonymous",session_id:c,device_type:y(),country:n.country,city:n.city,referrer_url:document.referrer,visit_duration:Math.floor(t/1e3),is_new_visitor:!1,is_bounce:!1,is_conversion:!1,browser:navigator.userAgent.toLowerCase().includes("chrome")?"chrome":navigator.userAgent.toLowerCase().includes("firefox")?"firefox":navigator.userAgent.toLowerCase().includes("safari")?"safari":"other"})});if(!d.ok)throw new Error(`Erreur HTTP: ${d.status}`)}catch(d){console.error("Erreur lors de l'envoi des données analytiques:",d)}},h=async()=>{if(!l()){r();return}if(document.hidden){const e=Date.now()-o;try{const t=Date.now(),n=await fetch(`/api/analytics/collect?_=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"session_end",session_id:c,user_id:p.user?.id||"anonymous",visit_duration:Math.floor(e/1e3),is_bounce:!1,is_conversion:!1,is_new_visitor:!1,page_url:window.location.pathname,page_title:document.title,device_type:y(),browser:"unknown"})});if(!n.ok)throw new Error(`Erreur HTTP: ${n.status}`)}catch(t){console.error("Erreur lors de l'envoi des données de fin de session:",t)}}},v=async()=>{const e=Date.now()-o;try{const t=Date.now(),n=await fetch(`/api/analytics/collect?_=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"session_end",session_id:c,user_id:p.user?.id||"anonymous",visit_duration:Math.floor(e/1e3),is_bounce:!1,is_conversion:!1,is_new_visitor:!1,page_url:window.location.pathname,page_title:document.title,device_type:y(),browser:"unknown"})});if(!n.ok)throw new Error(`Erreur HTTP: ${n.status}`)}catch(t){console.error("Erreur lors de l'envoi des données de fin de session:",t)}};k(()=>u.preferences.analytics,e=>{e?w():r()});const g=()=>{window.addEventListener("analytics-preference-changed",e=>{const t=e.detail?.enabled;console.log("Préférence analytics modifiée:",t),t?w():r()})};return S(()=>{g(),l()&&w()}),L(async()=>{await r()}),(e,t)=>(O(),P("div",A))}});export{x as _};
